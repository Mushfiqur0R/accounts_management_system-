{% extends "base.html" %}

{% block title %}Ledger for {{ client.name }}{% endblock %}

{% block content %}
<div class="report-container">
    <div class="print-header">
        {% if company_details and company_details.monogram_path %}
            <img src="{{ url_for('static', filename=company_details.monogram_path) }}" alt="Company Monogram" class="monogram">
        {% endif %}
        <h2>{{ company_details.company_name if company_details else "Company Name" }}</h2>
        <p>{{ company_details.address if company_details else "Company Address" }}</p>
        <p>{{ company_details.contact_info if company_details else "Contact Info" }}</p>
        <hr>
        <h3>Debtors Ledger</h3>
        <p><strong>Account Name:</strong> {{ client.name }}</p>
        <p><strong>Contact Number:</strong> {{ client.contact_number if client.contact_number else 'N/A' }}</p>
        <p><strong>Period:</strong>
            {% if start_date %}{{ start_date }}{% else %}Beginning{% endif %} to {{ end_date }}
        </p>
    </div>

    <form method="get" action="{{ url_for('client_ledger', client_id=client.id) }}" class="filter-form no-print">
        <label for="start_date">From:</label>
        <input type="date" name="start_date" id="start_date" value="{{ start_date }}">
        <label for="end_date">To:</label>
        <input type="date" name="end_date" id="end_date" value="{{ end_date }}">
        <button type="submit">Filter</button>
        <button type="button" onclick="window.location.href='{{ url_for('client_ledger', client_id=client.id) }}'">Clear Filters</button>
    </form>

    {% if transactions %}
    {# ... in client_ledger.html ... #}
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Fabrics</th>
                <th>Design</th>
                <th>Qty</th>
                <th>Mode</th>
                <th>Narration</th>
                <th>Chq No.</th>
                <th>Voucher No.</th>
                <th>Debit</th>
                <th>Credit</th>
                <th>Balance</th>
                <th class="no-print">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% if start_date and opening_balance != 0 %} {# Only show OB if it's not zero and filtered #}
            <tr>
                <td colspan="10" style="text-align:right;"><strong>Opening Balance</strong></td> {# Debit, Credit, Balance, Actions cells #}
                <td style="text-align:right;"><strong>{{ "%.2f"|format(opening_balance) }}</strong></td>
                <td class="no-print"></td> {# Empty cell for actions #}
            </tr>
            {% endif %}
            {% for trx in transactions %}
            <tr>
                <td>{{ trx.transaction_date }}</td>
                <td>{{ trx.fabrics_type if trx.fabrics_type else '' }}</td>
                <td>{{ trx.design_code if trx.design_code else '' }}</td>
                <td>{{ trx.qty if trx.qty is not none else '' }}</td>
                <td>{{ trx.transaction_mode }}</td>
                <td>{{ trx.narration if trx.narration else '' }}</td>
                <td>{{ trx.chq_no if trx.chq_no else '' }}</td>
                <td>{{ trx.challan_voucher_no if trx.challan_voucher_no else '' }}</td>
                <td style="text-align:right;">{{ "%.2f"|format(trx.debit) if trx.debit else '' }}</td>
                <td style="text-align:right;">{{ "%.2f"|format(trx.credit) if trx.credit else '' }}</td>
                <td style="text-align:right;">{{ "%.2f"|format(trx.running_balance) }}</td>
                <td class="no-print">
                    <a href="{{ url_for('edit_transaction', transaction_id=trx.id) }}">Edit</a>
                    {% if current_user.is_admin %} {# Only show delete to admins #}
                    | <form method="post" action="{{ url_for('delete_transaction', transaction_id=trx.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this transaction? This cannot be undone.');">
                        <button type="submit" class="link-button delete-button">Delete</button>
                    </form>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr>
                {# Date, Fabrics, Design, Qty, Mode, Narration, Chq No., Voucher No. = 8 columns for text #}
                <td colspan="8" style="text-align:right;"><strong>Totals for Period:</strong></td>
                <td style="text-align:right;"><strong>{{ "%.2f"|format(total_debit) }}</strong></td>
                <td style="text-align:right;"><strong>{{ "%.2f"|format(total_credit) }}</strong></td>
                <td></td> {# Balance column placeholder #}
                <td class="no-print"></td> {# Actions column placeholder #}
            </tr>
            <tr>
                {# Date to Credit = 10 columns for text #}
                <td colspan="10" style="text-align:right;"><strong>Closing Balance (as of {{ end_date }}):</strong></td>
                <td style="text-align:right;"><strong>{{ "%.2f"|format(closing_balance) }}</strong></td>
                <td class="no-print"></td> {# Actions column placeholder #}
            </tr>
        </tfoot>
    </table>
{# ... #}
    {% else %}
        <p>No transactions found for this period.</p>
        {% if not start_date %} <!-- Only show opening balance if no transactions and no start_date filter -->
            <p>Opening Balance: {{ "%.2f"|format(opening_balance) }}</p>
            <p>Closing Balance: {{ "%.2f"|format(closing_balance) }}</p>
        {% endif %}
    {% endif %}

    <div class="no-print">
        <a href="{{ url_for('add_transaction', client_id=client.id) }}" class="button">Add New Transaction</a>
        <button onclick="printReport()">Print Ledger</button>
        <p><a href="{{ url_for('index') }}">Back to Client List</a></p>
    </div>

    <div class="print-footer">
        <p>Printed on: {{ "now"|datetimeformat('%Y-%m-%d %H:%M:%S') }}</p>
        {% if company_details %} {# Added this check for robustness #}
        <p>{{ company_details.company_name if company_details.company_name else "Company Name" }} - {{ company_details.address if company_details.address else "Address" }} - {{ company_details.contact_info if company_details.contact_info else "Contact" }}</p>
        {% endif %}
    </div>
</div>
{% endblock %}